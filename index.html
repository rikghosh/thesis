<!DOCTYPE html>
<meta charset="utf-8">
<style>

.axis--x path, .axis--y path {
  display: none;
}

html {
  background: #fcfbf3;
}

#title {
  font-family: Garamond;
  font-size: 25px;
  letter-spacing: 0.22em;
  margin-left: 40px;
  margin-top: 50px;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}


#chart {
  width: 100%;
  height: 80%;
  position: absolute;
}
</style>
<div id="title" style="height: 50px; ">A CENTURY OF AMERICAN FOOD</div>
<div id="chart"></div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>


var xAxis, yAxis, food, foods; 

var svg = d3.select("#chart").append("svg");

var detail = false;

var margin = {top: 20, right: 80, bottom: 30, left: 50}
    width = parseInt(d3.select("#chart").style("width")) - margin.left - margin.right;
    height = parseInt(d3.select("#chart").style("height"))  - margin.top - margin.bottom;
    chartWrapper = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var x = d3.scaleLinear().range([0, width]),
    y = d3.scaleLinear().range([height, 0]),
    z = d3.scaleOrdinal(d3.schemeCategory10);

// path generator for line chart
var line = d3.line()
    .curve(d3.curveBasis)
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.percent); });
    
d3.queue()
.defer(d3.csv, "cal_food.csv", fixType)
.defer(d3.csv, "histevents.csv")
.await(function(error, data, eventdata) {
    if (error) throw error;
    else {
        initialize(data, eventdata);
    }
});


//d3.csv("cal_food.csv", fixType, initialize);

var colors = {
  meats: "#F36E4B",
  dairy: "#C8B384",
  fruits: "#F69431",
  veg: "#C6C752",
  fats: "#F1DD3E",
  sugars: "#F9B5B2",
  grains: "#95BAC6",
  eggs: "#B0CC9F",
  nuts: "#A2A18F"
}

var categories = {
    foodgroups: ["Total Meat", "Total Fats", "Total Veg", "Total Dairy", "Total Fruits", "Grains", "Sugars and Sweeteners", "Nuts and Legumes"],
    meats: ["Total Meat", "Meat", "Poultry", "Fish"],
    dairy: ["Total Dairy", "Whole Milk", "Lowfat Milk", "Cheese", "Other Dairy"],
    fruits: ["Total Fruits", "Citrus Fruits", "Non-Citrus Fruits"],
    veg: ["Total Veg", "White Potato", "Green Leafy Vegetables", "Tomatoes", "Other Veg"],
    fats: ["Total Fats", "Butter", "Margarine", "Shortening", "Lard and Tallow", "Vegetable Oils"],
    sugars: ["Sugars and Sweeteners"],
    grains: ["Grains"],
    eggs: ["Eggs"],
    nuts: ["Nuts and Legumes"],
    // none: ["Grains", "Sugars and Sweeteners", "Nuts and Legumes"]
}



// outputs array of all foodgroups that contain input
function classify (input) {
  var output = [];
  Object.keys(categories).map(function(group) {
    if (categories[group].includes(input))
      output.push(group);
  })
  return output;
}

console.log(classify("Total Meat"))
console.log(foodGroup("Total Meat"))


function initialize (data, eventdata) {
  

  // restructure data
  foods = data.columns.slice(1).map(function(id) {
      return {
        id: id,
        color: (classify(id) === undefined || classify(id).length == 0) ? "black" : colors[classify(id)[classify(id).length - 1]],
        values: data.map(function(d) {
          return {date: d.Year, percent: d[id]};
        })
      };
  });
  
  console.log(data)
  
  console.log(foods);
  

  foods = foods.filter(function(d) { return d.id != "Diabetes Incidence"})
  //foods = foods.filter(function(d) { return d.id == "Total Meat" || d.id == "Total Fats" || d.id == "Total Veg" || d.id == "Total Dairy" || d.id == "Total Fruits" || d.id == "Grains" || d.id == "Eggs"; });

  //foods = foods["Meat", "Total Fats", "Total Veg", "Total Dairy", "Total Fruits", "Grain\nProducts"]


  // initialize scales
  x.domain(d3.extent(data, function(d) { return d.Year; }));

  y.domain([
    //d3.min(foods, function(c) { return d3.min(c.values, function(d) { return d.percent; }); }),
    0, 
    d3.max(foods, function(c) { return d3.max(c.values, function(d) { return d.percent + 1; }); })
  ]);

  z.domain(foods.map(function(c) { return c.id; }));

  // intialize axes
  xAxis = d3.axisBottom(x);
  yAxis = d3.axisLeft(y);
  
  // bottom axis
  chartWrapper.append("g")
      .classed("axis axis--x", true)
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      // .append("text")
      //   .attr("x", width/2)
      //   .attr("y", 30)
      //   .attr("fill", "#000")
      //   .text("Year")

  // left axis
  chartWrapper.append("g")
      .classed("axis axis--y", true)
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("x", -height/2)
      .attr("y", -40)
      .attr("dy", "0.71em")
      .attr("fill", "#000")
      .text("Percent");
    
  events = chartWrapper.selectAll(".event")
    .data(eventdata)
    .enter().append("g")
      .attr("class", "event")
      
  events.append("line")
    .attr("x1", function(d) { return x(d.Year) })
    .attr("x2", function(d) { return x(d.Year) })
    .attr("y1", y(1))
    .attr("y2", y(d3.max(y.domain())))
    .attr("opacity", 0.2)
    .style("stroke-dasharray", ("3,3"))
    .attr("stroke-width", 1)
    .attr("stroke", "black")
    .on("mouseover", function(d) {
      d3.select(this)
        .attr("opacity", 0.5)
        .attr("stroke-width", 2)
        d3.select("#" + d.Id)
          .attr("display", "inline")
    })
    .on("mouseout", function() {
      d3.select(this)
        .attr("opacity", 0.2)
        .attr("stroke-width", 1)
      d3.selectAll(".eventtext")
        .attr("display", "none");
    })
    
  //   svg.append("foreignObject")
  //   .attr("width", 480)
  //   .attr("height", 500)
  // .append("xhtml:body")
  //   .style("font", "14px 'Helvetica Neue'")
  //   .html("<h1>An HTML Foreign Object in SVG</h1><p>Lorem
    
    events.append("foreignObject")
      .attr("x", function(d) { return x(d.Year) + 5 })
      .attr("y", y(d3.max(y.domain())) + 10)
      .attr("width", 100)
      .attr("height", 20)
      .style("margin-top", 0)
      .style("padding-top", 0)
      .attr("class", "eventtext")
      .attr("id", function(d) { return d.Id })
      .style("font", "11px sans-serif")
      .style("z-index", 100000)
      .attr("display", "none")
      .html(function(d) { return "<h3>" + d.Name + "</h3> <p>" + d.Summary + "</p>"})
    
    // events.append("text")
    //   .attr("x", function(d) { return x(d.Year) + 5 })
    //   .attr("y", y(d3.max(y.domain())) + 10)
    //   .attr("class", "eventtext")
    //   .attr("id", function(d) { return d.Id })
    //   .style("font", "11px sans-serif")
    //   .attr("display", "none")
    //   .text(function(d) { return d.Name })

  food = chartWrapper.selectAll(".food")
    .data(foods)
    .enter().append("g")
      .attr("class", function(d){ return classify(d.id).join(" ") })
      .classed("food", true)
      .style("display", "none")
      
  // var trial = d3.selectAll(".fats").remove()
  // console.log(trial);
  
  // var fats = chartWrapper.append("g")
  //   .attr("class", "fats")
  //   .append(function() { return trial.node() })
      
  d3.selectAll(".foodgroups") 
    .style("display", "inline");
  d3.selectAll(".none")
    .style("display", "inline");
      
  d3.select("svg")
    .on("mousedown", function() { console.log("hello") })


  food.append("path")
      .classed("line", true)
      .attr("d", function(d) { return line(d.values); })
      //.style("stroke", function(d) { return z(d.id); })
      .style("stroke", function(d) { return d.color })
      .on("mouseover", function(d) {
        if (!detail) {
          var toDisplay = d3.select(this.parentNode).attr("class").split(" ")[1]
          console.log(toDisplay);
          if (toDisplay != "food") {
            d3.selectAll("." + toDisplay + ":not(.foodgroups)")
              .style("display", "inline")
              .style("opacity", 0.5)
              .classed("temp", true)
          }
          // foods = foods.filter(function(d) { return d.id == "Meat" || d.id == "Total Fats" || d.id == "Total Veg" || d.id == "Total Dairy" || d.id == "Total Fruits" });
          if (d3.select(this.parentNode).attr("class").includes("foodgroup"))
            d3.select(this)
            .style("stroke-width", 3);
        }
          
      })
      
      .on("mouseout", function(d) {
        d3.select(this)
          .style("stroke-width", 1.5);
        d3.selectAll(".temp")
          .style("display", "none")
      })
      
      .on("mousedown", function(d) {
        if (!detail) {
          detail = true;
          var toDisplay = d3.select(this.parentNode).attr("class").split(" ")[1]
          var lastClass = d3.select(this.parentNode).attr("class").split(" ")
          lastClass = lastClass[lastClass.length - 1]
          // var fromScale = toScale = d3.min(d3.select(this.parentNode).data()[0].values.map(function(entry) { return entry.percent }))
          var toScale = d3.max(d3.select(this.parentNode).data()[0].values.map(function(entry) { return entry.percent }))
          console.log(toScale);
          
          d3.selectAll(".food")
            .style("display", "none");
          if (toDisplay != lastClass) {
            d3.selectAll("." + toDisplay)
              .style("display", "inline")
              .style("opacity", 1)
          }
          d3.selectAll(".temp")
              .classed("temp", false)
          y.domain([0, toScale + 1.5])
          render();
      }
      })

  food.append("text")
      .datum(function(d) { return {id: d.id, value: d.values[d.values.length - 1]}; })
      .classed("label", true)
      .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.percent) + ")"; })
      .attr("x", 3)
      .attr("dy", "0.35em")
      .style("font", "11px sans-serif")
      .text(function(d) { return d.id; });
      

  
  
    // svg.on("mousemove", function(d) { 
    //   // console.log(this);
    //   //d3.select("chartWrapper")
    //   console.log(Math.floor(x.invert(d3.mouse(this)[0])))
    //   // d3.select(this).append("text")
    //   //   .attr("transform", "rotate(-90)")
    //   //   .attr("y", d3.mouse(this)[1])
    //   //   .attr("x", d3.mouse(this)[0])
    //   //   .attr("fill", "#000")
    //     // .text(y(d3.mouse(this)[1]));
    // });
  
  render();
};




function render () {
  updateDimensions();
  
  // update x and y scale ranges to new dimensions
  x.range([0, width]);
  y.range([height, 0]);

  // update svg elements to new dimensions
  svg
    .attr('width', width + margin.right + margin.left)
    .attr('height', height + margin.top + margin.bottom);
  chartWrapper.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

  // update the axis and lines
  xAxis = d3.axisBottom(x).tickFormat(d3.format("d"));;
  yAxis = d3.axisLeft(y);
  
  svg.select('.axis.axis--x')
    .transition().duration(1000)
    .attr('transform', 'translate(0,' + height + ')')
    .call(xAxis);

  svg.select('.axis.axis--y')
    .transition().duration(1000)
    .call(yAxis);
    
  svg.selectAll('.label')
    .transition().duration(1000)
    .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.percent) + ")"; })
  
  svg.selectAll('.line')
    .transition().duration(1000)
    .attr('d', function(d) { return line(d.values); })
    
  
}



// function zoomed() {

//     var xDomain = x.domain(),
//         xRange = x.range(),
//         translate = zoom.translate()[0];

//     if (xDomain[0] < fromDate) {
//         translate = translate - xScale(fromDate) + xRange[0];
//     } else if (xDomain[1] > toDate) {
//         translate = translate - xScale(toDate) + xRange[1];
//     }
//     zoom.translate([translate, 0]);

//     chartWrapper.select('.foods')
//         .call(series);

//     chartWrapper.select('.axis.axis--x')
//         .call(xAxis);

//     chartWrapper.select('.axis.axis--y')
//         .call(yAxis);

// }

function updateDimensions() {
  margin = {top: 20, right: 80, bottom: 30, left: 50}
  width = parseInt(d3.select("#chart").style("width")) - margin.left - margin.right;
  height = parseInt(d3.select("#chart").style("height"))  - margin.top - margin.bottom;
}


function fixType(d, _, columns) {
  //d.date = parseTime(d.date);
  for (var i = 0, n = columns.length, c; i < n; ++i) d[c = columns[i]] = +d[c];
  return d;
  console.log(d);
}


// arrange data into food groups
function foodGroup(input) {
  // var groups = ["Total Meat", "Total Fats", "Total Veg", "Total Dairy", "Total Fruits"]
  // var meats = ["Meat", "Poultry", "Fish"]
  // var dairy = ["Whole Milk", "Lowfat Milk", "Cheese", "Other Dairy"]
  // var fruits = ["Citrus Fruits", "Non-Citrus Fruits"]
  // var veg = ["White Potato", "Green Leafy Vegetables", "Tomatoes", "Other Veg"]
  // var fats = ["Butter", "Margarine", "Shortening", "Lard and Tallow", "Vegetable Oils"]
  

  
  
  // if (groups.includes(input))
  //   if (input == "Total Meat")
  //     return "foodgroups meats";
  //   else if (input == "Total Dairy")
  //     return "foodgroups dairy";
  //   else if (input == "Total Fruits")
  //     return "foodgroups fruits";
  //   else if (input == "Total Veg")
  //     return "foodgroups veg";
  //   else if (input == "Total Fats")
  //     return "foodgroups fats";
  //   else
  //     return "foodgroup";
  // else if (meats.includes(input))
  //   return "meats";
  // else if (dairy.includes(input))
  //   return "dairy";
  // else if (fruits.includes(input))
  //   return "fruits";
  // else if (veg.includes(input))
  //   return "veg";
  // else if (fats.includes(input))
  //   return "fats";
  // else if (input == "Diabetes Incidence" || input == "Misc")
  //   return "remove";
  // else
  //   return "none"; 
  

  
  return classify(input).join(" ");
}

d3.select(window).on('resize', render);






</script>